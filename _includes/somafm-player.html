<!-- SomaFM DEF CON Radio Player -->
<div id="somafm-player" class="somafm-player">
  <div class="player-header">
    <div class="station-info">
      <div class="station-icon">
        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
          <!-- Radio wave circles -->
          <circle cx="20" cy="20" r="18" fill="none" stroke="#ff00ff" stroke-width="1" opacity="0.3"/>
          <circle cx="20" cy="20" r="14" fill="none" stroke="#ff00ff" stroke-width="1" opacity="0.5"/>
          <circle cx="20" cy="20" r="10" fill="none" stroke="#ff00ff" stroke-width="1" opacity="0.7"/>
          <!-- Center dot -->
          <circle cx="20" cy="20" r="4" fill="#9c1f8c"/>
          <!-- Signal bars -->
          <rect x="8" y="28" width="3" height="4" fill="#ff00ff" opacity="0.8"/>
          <rect x="13" y="26" width="3" height="6" fill="#ff00ff" opacity="0.8"/>
          <rect x="18" y="24" width="3" height="8" fill="#ff00ff" opacity="0.8"/>
          <rect x="23" y="26" width="3" height="6" fill="#ff00ff" opacity="0.8"/>
          <rect x="28" y="28" width="3" height="4" fill="#ff00ff" opacity="0.8"/>
        </svg>
      </div>
      <div class="station-text">
        <span class="station-name">DEF CON Radio <span class="via-somafm">via <a href="https://somafm.com/defcon/" target="_blank" rel="noopener">SomaFM</a></span></span>
        <span class="station-tagline">Music for Hacking</span>
      </div>
    </div>
    <button class="player-close" onclick="togglePlayer()" aria-label="Minimize player">
      <span>_</span>
    </button>
  </div>
  
  <div class="player-body">
    <audio id="defcon-audio" class="audio-element" preload="none">
      <!-- Multiple sources for redundancy -->
      <source src="https://ice1.somafm.com/defcon-128-mp3" type="audio/mpeg">
      <source src="https://ice4.somafm.com/defcon-128-mp3" type="audio/mpeg">
      <source src="https://ice2.somafm.com/defcon-128-mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
    
    <div class="player-controls">
      <button class="play-pause-btn" onclick="togglePlayPause()" aria-label="Play/Pause">
        <span class="play-icon">▶</span>
        <span class="pause-icon" style="display: none;">❚❚</span>
      </button>
      
      <div class="volume-control">
        <button class="mute-btn" onclick="toggleMute()" aria-label="Mute/Unmute">
          <span class="volume-icon">🔊</span>
          <span class="mute-icon" style="display: none;">🔇</span>
        </button>
        <input type="range" class="volume-slider" min="0" max="100" value="25" onchange="changeVolume(this.value)">
      </div>
    </div>
    
    <div class="now-playing">
      <span class="np-label">Now Playing:</span>
      <span class="np-text">Click play to start streaming</span>
    </div>
  </div>
  
  <!-- Minimized state -->
  <div class="player-minimized" style="display: none;">
    <button onclick="togglePlayer()" aria-label="Expand player">
      <span class="mini-icon">🎵</span>
      <span class="mini-text">DEF CON Radio</span>
    </button>
  </div>
</div>

<script>
// SomaFM Player JavaScript
const audio = document.getElementById('defcon-audio');
const playBtn = document.querySelector('.play-icon');
const pauseBtn = document.querySelector('.pause-icon');
const volumeIcon = document.querySelector('.volume-icon');
const muteIcon = document.querySelector('.mute-icon');
const volumeSlider = document.querySelector('.volume-slider');
const playerBody = document.querySelector('.player-body');
const playerHeader = document.querySelector('.player-header');
const playerMinimized = document.querySelector('.player-minimized');

// Initialize volume at 25% to avoid blowing out speakers
audio.volume = 0.25;

function togglePlayPause() {
  if (audio.paused) {
    audio.play().then(() => {
      playBtn.style.display = 'none';
      pauseBtn.style.display = 'inline';
      updateNowPlaying();
      // Update song info every 30 seconds while playing
      songUpdateInterval = setInterval(updateNowPlaying, 30000);
    }).catch(error => {
      console.error('Error playing audio:', error);
    });
  } else {
    audio.pause();
    playBtn.style.display = 'inline';
    pauseBtn.style.display = 'none';
    // Clear the update interval when paused
    if (songUpdateInterval) {
      clearInterval(songUpdateInterval);
      songUpdateInterval = null;
    }
    document.querySelector('.np-text').textContent = 'Click play to start streaming';
  }
}

function toggleMute() {
  if (audio.muted) {
    audio.muted = false;
    volumeIcon.style.display = 'inline';
    muteIcon.style.display = 'none';
    volumeSlider.value = audio.volume * 100;
  } else {
    audio.muted = true;
    volumeIcon.style.display = 'none';
    muteIcon.style.display = 'inline';
  }
}

function changeVolume(value) {
  audio.volume = value / 100;
  if (value == 0) {
    volumeIcon.style.display = 'none';
    muteIcon.style.display = 'inline';
  } else {
    volumeIcon.style.display = 'inline';
    muteIcon.style.display = 'none';
    audio.muted = false;
  }
}

function togglePlayer() {
  const isMinimized = playerBody.style.display === 'none';
  if (isMinimized) {
    playerBody.style.display = 'block';
    playerHeader.style.display = 'flex';
    playerMinimized.style.display = 'none';
  } else {
    playerBody.style.display = 'none';
    playerHeader.style.display = 'none';
    playerMinimized.style.display = 'block';
  }
}

// Fetch and update currently playing song
function updateNowPlaying() {
  const npText = document.querySelector('.np-text');
  
  // Fetch current song from SomaFM API
  fetch('https://somafm.com/songs/defcon.json')
    .then(response => response.json())
    .then(data => {
      if (data.songs && data.songs.length > 0) {
        const currentSong = data.songs[0]; // Most recent song
        npText.textContent = `${currentSong.artist} - ${currentSong.title}`;
      } else {
        npText.textContent = 'Streaming DEF CON Radio';
      }
    })
    .catch(error => {
      console.error('Error fetching song data:', error);
      npText.textContent = 'Streaming DEF CON Radio';
    });
}

// Update song info every 30 seconds
let songUpdateInterval;

// Handle audio errors by trying next source
audio.addEventListener('error', function() {
  const sources = audio.querySelectorAll('source');
  const currentSrc = audio.currentSrc;
  
  sources.forEach((source, index) => {
    if (source.src === currentSrc && index < sources.length - 1) {
      audio.src = sources[index + 1].src;
      audio.load();
      if (!audio.paused) {
        audio.play();
      }
    }
  });
});
</script>